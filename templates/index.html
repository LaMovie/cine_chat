<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cine Chat Global</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Contenedor de Video */
        #video-container { width: 100%; background: #000; position: relative; }
        video { width: 100%; aspect-ratio: 16/9; display: block; }
        
        #nombre-canal-actual { 
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); 
            padding: 5px 10px; border-radius: 5px; font-size: 0.8em; color: #0f0;
        }

        /* Botones de Canales (Controlados por Servidor) */
        #controles { 
            display: none; /* Se activa con CMD */
            flex-wrap: wrap; gap: 5px; padding: 10px; background: #111; justify-content: center;
        }
        button { 
            background: #333; color: white; border: 1px solid #444; 
            padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em;
        }
        button:hover { background: #555; }

        /* Área de Chat */
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #0a0a0a; }
        .msg-container { display: flex; flex-direction: column; margin-bottom: 5px; }
        .user-nick { font-size: 0.75em; color: #888; margin-bottom: 2px; margin-left: 5px; }
        .bubble { 
            background: #222; padding: 8px 12px; border-radius: 15px; 
            border-bottom-left-radius: 2px; max-width: 80%; align-self: flex-start; line-height: 1.4;
        }
        .channel-bubble { 
            align-self: center; background: rgba(0, 255, 0, 0.1); 
            color: #0f0; font-size: 0.7em; padding: 4px 10px; border-radius: 10px; border: 1px solid #0f0;
        }

        /* Input de Mensajes */
        #input-area { padding: 10px; background: #111; display: flex; gap: 8px; align-items: center; }
        #user-input { width: 80px; background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 5px; }
        #msg-input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 5px; outline: none; }
        #send-btn { background: #007bff; border: none; color: white; padding: 8px 15px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="video-container">
        <div id="nombre-canal-actual">Cargando...</div>
        <video id="reproductor" controls playsinline>
            <source id="video-source" src="" type="application/x-mpegURL">
        </video>
    </div>

    <div id="controles">
        <button onclick="cambiarVideo(0)">UNIVERSAL Tv</button>
        <button onclick="cambiarVideo(1)">CINE TERROR</button>
        <button onclick="cambiarVideo(2)">BUM Tv</button>
        <button onclick="cambiarVideo(3)">CLASSIC</button>
    </div>

    <div id="chat"></div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="Nick">
        <input type="text" id="msg-input" placeholder="Escribe un mensaje...">
        <button id="send-btn" onclick="enviarMensaje()">➤</button>
    </div>

<script>
    const listaVideos = [
        "https://imagenuniversaltv.net:3771/live/iutvlive.m3u8",
        "https://is.gd/GyYDz0",
        "https://movil.ejeserver.com/live/visiondorada.m3u8", 
        "https://is.gd/7CaWXu"
    ];
    const nombresCanales = ["UNIVERSAL Tv", "CINE TERROR", "BUM Tv", "CLASSIC"];
    
    let videoActualIdx = -1;
    let visibilidadActual = "none";
    let pausaScroll = false;
    let temporizadorPausa;

    window.onload = () => {
        const savedNick = localStorage.getItem('chat_nick');
        if (savedNick) {
            document.getElementById('user-input').value = savedNick;
            document.getElementById('user-input').disabled = true;
        }
        
        const chatDiv = document.getElementById('chat');
        chatDiv.addEventListener('scroll', () => {
            const estaAlFinal = (chatDiv.scrollHeight - chatDiv.scrollTop - chatDiv.clientHeight) < 30;
            if (!estaAlFinal) {
                pausaScroll = true;
                clearTimeout(temporizadorPausa);
                temporizadorPausa = setTimeout(() => { pausaScroll = false; }, 10000);
            }
        });
        actualizar();
    };

    async function cambiarVideo(idx) {
        // Primero anunciamos el cambio en el chat
        await fetch('/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user: "CANAL", msg: "Sintonizando: " + nombresCanales[idx]})
        });
        // Luego cambiamos el video globalmente
        await fetch('/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user: "SISTEMA", msg: "/video:" + idx})
        });
    }

    async function enviarMensaje() {
        const userInput = document.getElementById('user-input');
        const msgInput = document.getElementById('msg-input');
        const user = userInput.value.trim() || 'Anónimo';
        const msg = msgInput.value.trim();

        if (!msg) return;

        // Guardar nick
        if (!localStorage.getItem('chat_nick') && user !== 'Anónimo') {
            localStorage.setItem('chat_nick', user);
            userInput.disabled = true;
        }

        await fetch('/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user, msg})
        });

        msgInput.value = '';
        pausaScroll = false; 
        actualizar();
    }

    function renderizarChat(textoRaw) {
        const chatDiv = document.getElementById('chat');
        const lineas = textoRaw.trim().split('\n');
        chatDiv.innerHTML = '';
        
        lineas.forEach(linea => {
            if(!linea.includes(':')) return;
            const [nombre, ...mensajePartes] = linea.split(':');
            const mensaje = mensajePartes.join(':').trim();
            const container = document.createElement('div');
            container.className = 'msg-container';
            
            if(nombre.trim() === "CANAL") {
                container.innerHTML = `<div class="channel-bubble">${mensaje}</div>`;
            } else if(nombre.trim() !== "SISTEMA") {
                container.innerHTML = `<div class="user-nick">${nombre}</div><div class="bubble">${mensaje}</div>`;
            }
            chatDiv.appendChild(container);
        });

        if (!pausaScroll) chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function actualizar() {
        try {
            const res = await fetch('/messages');
            const data = await res.json();
            
            renderizarChat(data.messages);

            // Sincronizar Controles (CMD/CMX)
            if (data.controles !== visibilidadActual) {
                visibilidadActual = data.controles;
                document.getElementById('controles').style.display = visibilidadActual;
            }

            // Sincronizar Video
            let serverVideoIdx = parseInt(data.video_index);
            if (serverVideoIdx !== videoActualIdx && serverVideoIdx >= 0) {
                videoActualIdx = serverVideoIdx;
                document.getElementById('nombre-canal-actual').innerText = nombresCanales[videoActualIdx];
                const video = document.getElementById('reproductor');
                const source = document.getElementById('video-source');
                source.src = listaVideos[videoActualIdx];
                video.load();
                video.play().catch(e => console.log("Auto-play bloqueado"));
            }
        } catch (e) { console.error("Error de conexión"); }
    }

    setInterval(actualizar, 2000);

    document.getElementById('msg-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') enviarMensaje();
    });
</script>
</body>
</html>
